{% extends "public/templates/public_template.html" %}
{% block style %}
<style type="text/css">
    body {
      background-color: linen;
      margin:0;
    }
    
    h1 {
      color: maroon;
      margin-left: 40px;
    }
    .top_margine {
        margin: 50px, 0px, 0px, 0px;
    }
    .main_image {
        width: 960px;
        height: 720px;
    }
    .a1 {
        position: absolute;
        top:198px;
        left:133px;
    }
    .box_g {
        background-color: green;
        opacity: 0.5;
        width: 76px;
        height: 48px;
    }
</style>
{% endblock %}
{% block title %}Scoring{% endblock %}

{% block main %}
<div class ="content-section" id = "content" style="padding: 10px; margin-top: 56px;">
    <div id = top_margine>
        <div id = "area"></div>
        <div id = "mistake"></div>
        <div id = "time" class ="container">
            <div class = "row">
            <!--    <div class ="col-sm">  -->
                    <select name="minutes" id ="minutes">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                        <option value="41">41</option>
                        <option value="42">42</option>
                        <option value="43">43</option>
                        <option value="44">44</option>
                        <option value="45">45</option>
                        <option value="46">46</option>
                        <option value="47">47</option>
                        <option value="48">48</option>
                        <option value="49">49</option>
                        <option value="50">50</option>
                        <option value="51">51</option>
                        <option value="52">52</option>
                        <option value="53">53</option>
                        <option value="54">54</option>
                        <option value="55">55</option>
                        <option value="56">56</option>
                        <option value="57">57</option>
                        <option value="58">58</option>
                        <option value="59">59</option>
                    </select>
                    <P>Minute(s)</P>
                <!--</div>
                <div class ="col-sm"> -->
                    <select name="seconds" id ="seconds">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                        <option value="17">17</option>
                        <option value="18">18</option>
                        <option value="19">19</option>
                        <option value="20">20</option>
                        <option value="21">21</option>
                        <option value="22">22</option>
                        <option value="23">23</option>
                        <option value="24">24</option>
                        <option value="25">25</option>
                        <option value="26">26</option>
                        <option value="27">27</option>
                        <option value="28">28</option>
                        <option value="29">29</option>
                        <option value="30">30</option>
                        <option value="31">31</option>
                        <option value="32">32</option>
                        <option value="33">33</option>
                        <option value="34">34</option>
                        <option value="35">35</option>
                        <option value="36">36</option>
                        <option value="37">37</option>
                        <option value="38">38</option>
                        <option value="39">39</option>
                        <option value="40">40</option>
                        <option value="41">41</option>
                        <option value="42">42</option>
                        <option value="43">43</option>
                        <option value="44">44</option>
                        <option value="45">45</option>
                        <option value="46">46</option>
                        <option value="47">47</option>
                        <option value="48">48</option>
                        <option value="49">49</option>
                        <option value="50">50</option>
                        <option value="51">51</option>
                        <option value="52">52</option>
                        <option value="53">53</option>
                        <option value="54">54</option>
                        <option value="55">55</option>
                        <option value="56">56</option>
                        <option value="57">57</option>
                        <option value="58">58</option>
                        <option value="59">59</option>
                    </select>
                    <P>Second(s)</P>
                <!-- </div> -->
            </div>
        </div>
        <div id = child>
            <p>Registered Child</p>
                {% if children %}
                    {% if child_num == 0 %}
                        <p><strong>No child registered</strong></p>	
                        <a class="" href="{{ url_for ('add_child') }}">Register a child</a>
                    {% endif %}
                    {% if child_num == 1 %}
                        <p value = "{{ child.cid }}">{{ child.cfirst}} {{ child.clast}}</p>
                    {% else %}
                        <select name="child" id ="child">
                        {% for child in children %}
                            <option value = "{{ child.cid }}">{{ child.cfirst}} {{ child.clast}} </option>
                        {% endfor %}
                        </select>
                    {% endif %}    
                {% else %}
                    <p><strong>No child registered</strong></p>	
                    <a class="" href="{{ url_for ('add_child') }}">Register a child</a>
                {% endif %}
        </div>
        <div id = submit>
            <button type="button" class="btn btn-primary" onclick ="button_click()">Submit</button>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    var txt = "";
    var v_margin = 60;
    var h, h2, cell_height, cell_width, cell_rows, cell_cols, cells, eval_data;
    h = h2 = cell_height = cell_width = cell_rows = cell_cols = 0; m=0;

    

    //window.onload = function() {
    //    document.getElementById('main').innerHTML = "<main>test</main>";
    //    console.log(`JS onload`)
    //}

    function json_start(data) {
        var res = {"action": "JSON"};
        console.log(`submit confirmation`);
        fetch(`${window.origin}/api`, {
            method: "POST",
            credentials: "include",
            body: JSON.stringify(res),
            cache: "no-cache",
            headers: new Headers({
                "content-type": "application/json"
            })
        })
        .then(function (response) {
            if (response.status !== 200) {
                console.log(`Response status was not 200: ${response.status}`);
                return;
            }
            response.json().then(function(data) {
                console.log("Received data[evali]: ", data["eval"]);
                eval_data = data["eval"];
                document.getElementById('content').style = "padding: 0px; margin-top: 56px";
                rendering(data);
            })
        })
    }

    function rendering(data) {
        //console.log(data)
        // print(data.path)
        // document.getElementById('area').innerHTML = '<img src=' + String(data.path) + '>'
        // + '<div id ="loop"></div>'
        var bc = "";
        cell_height = parseInt(data.eval.eval[0]["row_h"]);
        cell_width = parseInt(data.eval.eval[0]["col_w"]);
        cell_rows = data.eval.eval[0]["row"];
        cell_cols = data.eval.eval[0]["col"];
        cells = data.eval.eval[0]["eval_cells"];
        txt = '<table class=\"table\"><thead><tr><th scope=\"col\"> Answer</th><th scope=\"col\"><Image></th></tr></thead><tbody>';
        data.eval.eval.forEach(element => {
            cells.forEach(cellFunction);
            txt = txt + "</tbody></table>"
            // arrows(data.total_files, data.number_of_file);
            document.getElementById('area').innerHTML = txt;
            number_of_mistakes();
        })
        return;
    }

    function cellFunction(value, index, array){
        h = v_margin + parseInt(value.upper_y);
        h2 = v_margin + parseInt(value.upper_y) + 20;
        g = 0
        r = parseInt(value.row)
        c = parseInt(value.col)
        //console.log("row ",parseInt(value.row), "col",parseInt(value.col));
        //console.log("eval_data.eval ", eval_data.eval, "eval_data.eval[0] ",eval_data.eval[0]);
        cell_id = r*9+c;
        if (String(eval_data["reviewed"]) == "false"){
            if (String(value.match) == "true"){
                bc = "white";
                eval_data.eval[0].eval_cells[cell_id]["color"]="white";
                eval_data.eval[0].eval_cells[cell_id]["correct"]=true;
            } else {
                bc = "pink";
                eval_data.eval[0].eval_cells[cell_id]["color"]="pink";
            }   
        } else {
            if (String(eval_data.eval[0].eval_cells[cell_id]["correct"]) == "true") {
                bc = "white";
                eval_data.eval[0].eval_cells[cell_id]["color"]="white";
            } else {
                bc = "pink";
                eval_data.eval[0].eval_cells[cell_id]["color"]="pink";
            }
        }
        txt = txt + "<tr><th scope=\"row\">" + String(value.answer) + "</th><td " + style + "= \"background-color: " + bc + "; opacity: 0.3; z-index: 50;\" " 
            + "onclick=\"cell_click('" + String(value.row) + String(value.col) + "')\"><img " 
            + String(data.path) + "/" + String(g) + "-" + String(r) + "-" + String(c) + ".png></td></tr>";
    }

    function cell_click(id){
        // console.log(id);
        r = Math.floor(parseInt(id)/10);
        c = parseInt(id)%10;
        if (document.getElementById(id).style.backgroundColor == "pink"){
            document.getElementById(id).style.backgroundColor="white";
            eval_data.eval[0].eval_cells[r*9+c]["color"]="white";
            eval_data.eval[0].eval_cells[r*9+c]["correct"]=true;
            // cells[r*9+c]["miss_recog"] = false;
        }else if (document.getElementById(id).style.backgroundColor == "white"){
            document.getElementById(id).style.backgroundColor="pink";
            eval_data.eval[0].eval_cells[r*9+c]["color"]="pink";
            eval_data.eval[0].eval_cells[r*9+c]["correct"]=false;
            // cells[r*9+c]["miss_recog"] = true;
        }
        number_of_mistakes();
    }

    function number_of_mistakes(){
        m = 0;
        // console.log("number of mistakes", m, "Cells ",eval_data.eval[0].eval_cells );
        for (i in eval_data.eval[0].eval_cells){
            if (eval_data.eval[0].eval_cells[i]["color"]=="pink"){
                m += 1;
                // console.log("number of mistakes", m, "Cell color ",eval_data.eval[0].eval_cells[i]["color"] );
            }
        };
        txt2 = "<div id = \"m\" >Number of Mistakes: " + String(m) + "</div>";
        document.getElementById("mistake").innerHTML = txt2;
    }

    //    document.getElementById('target').addEventListener('click',function(){
    //要素の取得 → 背景色を変える
    //document.getElementById('target').style.background='pink';
    //});
    function arrows(total, this_file){
        var action = "End"
        // Display "End of Review"
        txt = txt + "<div id = \"stop_eval\" style=\"position: absolute; top: 80px; left: 200px; "
         + "background-color: #003399; opacity: 0.7; width: 160px; height: 30px; " 
         + "border: 2px solid blue; border-radius: 3px; z-index: 60; \" onclick=\"button_click" 
         + "('" + action + "')\"><div id = \"button_txt\" style=\"text-align: center; color: white; " 
         + "opacity: 1; z-index: 70;\">End Review</div></div>"
         // Display "Number of Mistakes"
         txt = txt + "<div id = \"mis\" style=\"position: absolute; top: 80px; left: 500px; "
         + "background-color: #003399; opacity: 0.7; width: 200px; height: 30px; " 
         + "border: 2px solid blue; border-radius: 3px; z-index: 60; \">"
         + "<div id = \"mistake\" style=\"text-align: center; color: white; " 
         + "opacity: 1; z-index: 70;\">Number of Mistakes: " + "<div id = \"m\" >" + m + "</div></div></div>"
        if (total > 1){
            if(this_file == 0){
                action = "+"
                txt = txt + "<div id = \"right_arrow\" style=\"position: absolute; top: 450px; left: 880px; "
                + "width: 30px; height: 46px; z-index: 94;\" onclick=\"button_click('" + action + "')\">" 
                + "<img src= \"static/img/right_arrow.png\"></div>"
            } else if(this_file == total - 1){
                action = "-"
                txt = txt + "<div id = \"left_arrow\" style=\"position: absolute; top: 450px; left: 10px; "
                + "width: 30px; height: 46px; z-index: 93;\" onclick=\"button_click('" + action + "')\">" 
                + "<img src= \"static/img/left_arrow.png\"></div>"
            } else {
                action = "+"
                txt = txt + "<div id = \"right_arrow\" style=\"position: absolute; top: 450px; left: 880px; "
                + "width: 30px; height: 46px; z-index: 94;\" onclick=\"button_click('" + action + "')\">" 
                + "<img src= \"static/img/right_arrow.png\"></div>"
                action = "-"
                txt = txt + "<div id = \"left_arrow\" style=\"position: absolute; top: 450px; left: 10px; "
                + "width: 30px; height: 46px; z-index: 93;\" onclick=\"button_click('" + action + "')\">"
                + "<img src= \"static/img/left_arrow.png\"></div>"
            }
        } 
    }

    function rendering_endpage(data){
        console.log("rendering endpage");
        txt3 = "<div id =\"end_page\" style=\"position: absolute; top: 0px; margin-top: 56px; padding: 30px; \">"
                + "<div id =\"mis\">Number of Mistakes<ul>";
        for (i in data.eval){
            txt3 = txt3 + "<li>" + data.eval[i]["image"] + ": " + data.eval[i]["mistakes"] + "</li>";
        } 
        action = "JSON"
        txt3 = txt3 + "</ul></div><a href = \/home>Go to Home</a><br><div id = \"goback\" onclick=\"button_click('" + action + "')\">Return to Evaluation</div></div>";
        document.getElementById('area').innerHTML = txt3;
        return
    }

    function button_click(action){
        // console.log("Cells: ",cells)
        // eval_data.eval[0]["eval"] = cells;
        child = $("#child").children("Option:selected")
        eval_data["reviewed"]=true;
        eval_data["mistakes"]=m;
        eval_data["child"] = child.val();
        eval_data["child_name"] = child.text();
        eval_data["minutes"] = $("#minutes").val();
        eval_data["seconds"] = $("#seconds").val();
        var res = {"action": action, "data": eval_data};
        //console.log("action", action, "data", eval_data);
        fetch(`/api`, {
        method: "POST",
        credentials: "include",
        body: JSON.stringify(res),
        cache: "no-cache",
        headers: new Headers({
            "content-type": "application/json",
            "accept": "application/json"
            })
        })
        .then(function (response) {
        if (response.status !== 200) {
            console.log(`Response status was not 200: ${response.status}`);
            return;
        }
        response.json().then(function(data) {
            console.log("type", data["type"], "Data ", data);
            if (data["type"] == "eval"){
                eval_data = data["eval"];
                rendering(data);
            } else {
            //    rendering_endpage(data);
            }
                      
            })
        })
    }
</script>

{% endblock %}